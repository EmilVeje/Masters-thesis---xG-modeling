---
title: "Evaluate left-footed models"
output: html_document
date: "2025-10-07"
---

Loading R packages:
```{r}
library(tidyverse)
library(h2o)
library(pROC)
library(caret)
library(ROCR)
library(DALEX)
library(pdp)
library(ggsoccer)
library(RColorBrewer)
library(gridExtra)
library(h2o)
library(ingredients)
```

Loading data used to model:
```{r}
data_left <- readRDS("data_left.rds")
data_left <- data_left %>%
  mutate(position = case_when(
    position %in% c("Goalkeeper", "Defender") ~ "Defender",
    TRUE ~ as.character(position)
  ),
  position = factor(position, levels = c("Defender", "Midfielder", "Forward")))
```

Setting testing dataset and features:
```{r}
h2o.init(nthreads = -1, max_mem_size = "4G")
data_h2o <- as.h2o(data_left)
data_split = h2o.splitFrame(data = data_h2o, ratios = 0.8, seed=2025)
data_train = data_split[[1]]
data_test = data_split[[2]]

Y = "is_goal"
X2 = setdiff(h2o.names(data_train), Y)
X1 = c("distance_to_goal_line", "angle_to_goal")
```

Loading model with all features:
```{r}
modelname2 <- "" #Insert model name here
cmod2 <- h2o.loadModel(paste0("saved-models/", modelname2))
```

Variable importance:
```{r}
vi2 <- h2o.varimp(cmod2)
vi2
h2o.varimp_plot(cmod2, num_of_features = length(X2))
```

Model Performance:
```{r}
pred <- h2o.predict(cmod2, newdata = data_test)
(perf <- h2o.performance(cmod2, newdata = data_test, valid=T))
```

Model Performance with another packages:
```{r}
data_test_r <- as.data.frame(data_test)
pred_r <- as.data.frame(pred)

roc <- roc(data_test_r$is_goal, pred_r$p1)
plot.roc(roc, print.auc = TRUE, print.thres = "best")

best_thres <- coords(roc, "best", ret = "threshold", transpose = T)
h2o.confusionMatrix(cmod2, data_test, thresholds = best_thres, metrics = "mean_per_class_accuracy")

pred_r$xG_bool <- ifelse(pred_r$p1 > best_thres, 1, 0)
(result <- confusionMatrix(data = factor(pred_r$xG_bool), 
                           reference = factor(data_test_r$is_goal), positive = "1", mode="prec_recall"))
```


Loading model with only 2 features:
```{r}
modelname1 <- "" #Insert model name here
cmod1 <- h2o.loadModel(paste0("saved-models/", modelname1))
```

Variable importance:
```{r}
vi1 <- h2o.varimp(cmod1)
vi1
h2o.varimp_plot(cmod1, num_of_features = length(X1))
```

Model Performance:
```{r}
pred <- h2o.predict(cmod1, newdata = data_test)
(perf <- h2o.performance(cmod1, newdata = data_test, valid=T))
```

Model Performance with another packages:
```{r}
data_test_r <- as.data.frame(data_test)
pred_r <- as.data.frame(pred)

roc <- roc(data_test_r$is_goal, pred_r$p1)
plot.roc(roc, print.auc = TRUE, print.thres = "best")

best_thres <- coords(roc, "best", ret = "threshold", transpose = T)
h2o.confusionMatrix(cmod1, data_test, thresholds = best_thres, metrics = "mean_per_class_accuracy")

pred_r$xG_bool <- ifelse(pred_r$p1 > best_thres, 1, 0)
(result <- confusionMatrix(data = factor(pred_r$xG_bool), 
                           reference = factor(data_test_r$is_goal), positive = "1", mode="prec_recall"))
```

Results analysis:
```{r}
pred_1 <- h2o.predict(cmod1, newdata = data_test)
pred_r_1 <- as.data.frame(pred_1)

pred_2 <- h2o.predict(cmod2, newdata = data_test)
pred_r_2 <- as.data.frame(pred_2)
```

xG values distribution:
```{r}
ggplot(pred_r_2, aes(x=p1)) + 
        geom_density() +
        labs(x="xG") +
        theme_bw() +
        scale_x_continuous(limits = c(0, 1), expand = c(0, 0)) +
        scale_y_continuous(limits = c(0, 10), expand = c(0, 0))

ggsave("density_xg_plot_left.png", width = 10, height = 5)

data_test_r <- as.data.frame(data_test)
xx <- data_test_r %>% mutate(xG = pred_r_2$p1)

ggplot(data = xx, aes(x= x1, y = y1)) + 
        annotate_pitch(colour = "white",
                       fill   = "black",
                       limits = FALSE) +
        theme_pitch() +
        theme(plot.background = element_rect(fill = "black"),
              title = element_text(colour = "white")) +
        coord_flip(xlim = c(50, 100),
                   ylim = c(0, 100)) +
        geom_tile(aes(fill = xG)) +
        scale_fill_gradientn(colours = rev(brewer.pal(7, "Spectral"))) +
        theme(legend.position = c(0.76, 1), legend.direction = "horizontal",
              legend.text = element_text(color = "white", size = 8, face = "plain"),
              legend.background = element_rect(fill = "black"),
              legend.key = element_rect(fill = "black", color = "black"),
              plot.title = element_text(hjust = 0.07, face = "plain"),
              plot.subtitle = element_text(hjust = 0.07, size = 10, face = "italic"),
              plot.caption = element_text(hjust = 0.95),
              plot.margin = margin(1, 0.2, 0.5, 0.2, "cm")) +
        labs(fill = "xG value")


ggsave("xG_plot2_left.png", width = 10*1.3, height = 5*1.6)
```

Partial dependency plot skilled foot:
```{r}
custom_predict <- function(model, newdata) {
        newdata_h2o <- as.h2o(newdata)
        res <- as.data.frame(h2o.predict(model, newdata_h2o))
        return(as.numeric(as.character(res$predict)))
}
explainer_gbm_2 <- DALEX::explain(model = cmod2, 
                                    data = as.data.frame(data_test)[, X2],
                                    y = as.numeric(as.character(as.data.frame(data_test)[, Y])),
                                    predict_function = custom_predict,
                                    label = "GBM all")
mp_gbm_2 <- model_performance(explainer_gbm_2)
```



```{r}
pdp_gbm_2_foot <- partial_dependency(explainer_gbm_2, variables = "skilled_foot")
plot(pdp_gbm_2_foot)
```

```{r}
png(filename = "Partial_foot_left.png", width = 8, height = 5, units = "in", res = 300)
plot(pdp_gbm_2_foot)
dev.off()
```



